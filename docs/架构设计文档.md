# 文生漫画视频工具 - Go API服务架构设计文档

## 1. 架构概述

### 1.1 设计原则

- **高性能**: 基于Go的高并发特性,支持大量并发请求
- **可扩展**: 微服务化设计,支持水平扩展
- **高可用**: 服务降级、熔断、限流机制
- **模块化**: 清晰的分层架构,便于维护和扩展
- **异步处理**: AI生成等耗时任务采用异步队列处理

### 1.2 技术栈选型

#### 核心框架
- **Web框架**: Gin (高性能HTTP框架)
- **配置管理**: Viper
- **日志**: Zap (高性能日志库)
- **API文档**: Swagger (go-swagger/swaggo)

#### 数据存储
- **主数据库**: PostgreSQL (关系型数据,项目/用户等)
- **文档数据库**: MongoDB (非结构化数据,剧本解析结果)
- **缓存**: Redis (会话、任务状态、热点数据)
- **对象存储**: MinIO/S3 (图片、视频、音频文件)

#### 消息队列与任务调度
- **消息队列**: RabbitMQ / NATS
- **任务队列**: Asynq (基于Redis的Go任务队列)
- **定时任务**: Cron

#### 微服务通信
- **RPC**: gRPC (服务间通信)
- **服务发现**: Consul / etcd
- **API网关**: Kong / Traefik

#### 监控与追踪
- **监控**: Prometheus + Grafana
- **链路追踪**: Jaeger / OpenTelemetry
- **告警**: AlertManager

---

## 2. 系统架构图

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                        客户端层                              │
│              Web App / Mobile App / CLI                     │
└────────────────────────┬────────────────────────────────────┘
                         │ HTTPS
┌────────────────────────┼────────────────────────────────────┐
│                        │ API网关层                           │
│          ┌─────────────┴──────────────┐                     │
│          │  API Gateway (Kong/Traefik)│                     │
│          │  - 认证/授权                │                     │
│          │  - 限流/熔断                │                     │
│          │  - 负载均衡                 │                     │
│          └─────────────┬──────────────┘                     │
└────────────────────────┼────────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────────┐
│                   应用服务层 (Go Services)                   │
│                        │                                     │
│  ┌─────────────┬──────┴──────┬──────────────┬─────────────┐ │
│  │             │             │              │             │ │
│  │  用户服务   │  项目服务   │  生成服务    │  渲染服务   │ │
│  │  (User)     │  (Project)  │  (Generator) │  (Render)   │ │
│  │             │             │              │             │ │
│  └──────┬──────┴──────┬──────┴──────┬───────┴──────┬──────┘ │
│         │             │             │              │        │
│  ┌──────┴──────┬──────┴──────┬──────┴───────┬──────┴──────┐ │
│  │             │             │              │             │ │
│  │  剧本服务   │  素材服务   │  音频服务    │  导出服务   │ │
│  │  (Script)   │  (Asset)    │  (Audio)     │  (Export)   │ │
│  │             │             │              │             │ │
│  └─────────────┴─────────────┴──────────────┴─────────────┘ │
└────────────────────────┬────────────────────────────────────┘
                         │ gRPC / HTTP
┌────────────────────────┼────────────────────────────────────┐
│                   AI引擎层                                   │
│                        │                                     │
│  ┌─────────────────────┴─────────────────────────────────┐  │
│  │                  Python AI Services                    │  │
│  │  ┌──────────┐  ┌──────────┐  ┌──────────┐            │  │
│  │  │图像生成  │  │NLP处理   │  │语音合成  │            │  │
│  │  │SD/SDXL   │  │GPT/LLaMA │  │TTS       │            │  │
│  │  └──────────┘  └──────────┘  └──────────┘            │  │
│  └───────────────────────────────────────────────────────┘  │
└────────────────────────┬────────────────────────────────────┘
                         │
┌────────────────────────┼────────────────────────────────────┐
│                   基础设施层                                 │
│                        │                                     │
│  ┌─────────────┬──────┴──────┬──────────────┬─────────────┐ │
│  │             │             │              │             │ │
│  │ PostgreSQL  │  MongoDB    │   Redis      │  RabbitMQ   │ │
│  │             │             │              │             │ │
│  └─────────────┴─────────────┴──────────────┴─────────────┘ │
│                                                              │
│  ┌─────────────┬─────────────┬──────────────┬─────────────┐ │
│  │             │             │              │             │ │
│  │  MinIO/S3   │  Consul     │  Prometheus  │   Jaeger    │ │
│  │             │             │              │             │ │
│  └─────────────┴─────────────┴──────────────┴─────────────┘ │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 服务依赖关系图

```
API Gateway
    │
    ├─> User Service
    │       └─> Redis (Session)
    │       └─> PostgreSQL (User Data)
    │
    ├─> Project Service
    │       ├─> PostgreSQL (Project Data)
    │       └─> Script Service
    │       └─> Asset Service
    │
    ├─> Script Service
    │       ├─> MongoDB (Parsed Script)
    │       ├─> NLP Service (AI)
    │       └─> Storyboard Generator
    │
    ├─> Generator Service
    │       ├─> RabbitMQ (Task Queue)
    │       ├─> Image Generation Service (AI)
    │       ├─> Asset Service
    │       └─> Redis (Task Status)
    │
    ├─> Audio Service
    │       ├─> TTS Service (AI)
    │       ├─> Asset Service
    │       └─> RabbitMQ
    │
    └─> Render Service
            ├─> FFmpeg Worker
            ├─> Asset Service
            ├─> Export Service
            └─> RabbitMQ
```

---

## 3. 服务模块设计

### 3.1 用户服务 (User Service)

#### 职责
- 用户注册、登录、认证
- 用户信息管理
- 权限管理
- 订阅与配额管理

#### API接口

```go
// 用户注册
POST /api/v1/auth/register
Request: {
    "email": "user@example.com",
    "password": "encrypted_password",
    "username": "user123"
}
Response: {
    "user_id": "uuid",
    "access_token": "jwt_token",
    "refresh_token": "refresh_token"
}

// 用户登录
POST /api/v1/auth/login
Request: {
    "email": "user@example.com",
    "password": "password"
}
Response: {
    "access_token": "jwt_token",
    "refresh_token": "refresh_token",
    "user": {...}
}

// 获取用户信息
GET /api/v1/users/{user_id}
Response: {
    "id": "uuid",
    "username": "user123",
    "email": "user@example.com",
    "subscription": {
        "plan": "basic|pro|enterprise",
        "quota": {
            "videos_remaining": 25,
            "videos_total": 30
        }
    }
}

// 更新用户配置
PATCH /api/v1/users/{user_id}
Request: {
    "username": "new_username",
    "preferences": {...}
}
```

#### 数据模型

```go
type User struct {
    ID           string    `gorm:"primaryKey;type:uuid"`
    Email        string    `gorm:"uniqueIndex;not null"`
    Username     string    `gorm:"uniqueIndex;not null"`
    PasswordHash string    `gorm:"not null"`
    Status       string    `gorm:"default:'active'"` // active, suspended
    CreatedAt    time.Time
    UpdatedAt    time.Time
}

type Subscription struct {
    ID              string    `gorm:"primaryKey;type:uuid"`
    UserID          string    `gorm:"index;not null"`
    Plan            string    `gorm:"not null"` // free, basic, pro, enterprise
    Status          string    `gorm:"default:'active'"` // active, expired, cancelled
    VideosQuota     int       `gorm:"default:5"`
    VideosUsed      int       `gorm:"default:0"`
    ExpiresAt       time.Time
    CreatedAt       time.Time
    UpdatedAt       time.Time
}
```

---

### 3.2 项目服务 (Project Service)

#### 职责
- 项目CRUD操作
- 项目配置管理
- 项目状态管理
- 项目列表查询

#### API接口

```go
// 创建项目
POST /api/v1/projects
Request: {
    "name": "我的第一个漫画视频",
    "description": "测试项目",
    "style": "anime",  // anime, chinese, comic, chibi
    "aspect_ratio": "9:16",  // 16:9, 9:16, 1:1
    "target_duration": 60  // 秒
}
Response: {
    "project_id": "uuid",
    "status": "draft"
}

// 获取项目列表
GET /api/v1/projects?page=1&page_size=20&status=draft
Response: {
    "projects": [
        {
            "id": "uuid",
            "name": "项目名称",
            "status": "draft|generating|completed",
            "progress": 75,
            "created_at": "2025-10-26T10:00:00Z",
            "updated_at": "2025-10-26T12:00:00Z"
        }
    ],
    "total": 50,
    "page": 1,
    "page_size": 20
}

// 获取项目详情
GET /api/v1/projects/{project_id}
Response: {
    "id": "uuid",
    "name": "项目名称",
    "style": "anime",
    "aspect_ratio": "9:16",
    "target_duration": 60,
    "status": "generating",
    "progress": 45,
    "script": {...},
    "storyboard": {...},
    "created_at": "...",
    "updated_at": "..."
}

// 更新项目
PATCH /api/v1/projects/{project_id}
Request: {
    "name": "新项目名称",
    "description": "更新描述"
}

// 删除项目
DELETE /api/v1/projects/{project_id}
```

#### 数据模型

```go
type Project struct {
    ID             string    `gorm:"primaryKey;type:uuid"`
    UserID         string    `gorm:"index;not null"`
    Name           string    `gorm:"not null"`
    Description    string
    Style          string    `gorm:"not null"` // anime, chinese, comic, chibi
    AspectRatio    string    `gorm:"not null"` // 16:9, 9:16, 1:1
    TargetDuration int       `gorm:"default:60"` // seconds
    Status         string    `gorm:"default:'draft'"` // draft, generating, completed, failed
    Progress       int       `gorm:"default:0"` // 0-100
    CreatedAt      time.Time
    UpdatedAt      time.Time
}

type ProjectConfig struct {
    ID        string `gorm:"primaryKey;type:uuid"`
    ProjectID string `gorm:"uniqueIndex;not null"`
    Config    JSONB  `gorm:"type:jsonb"` // 存储项目配置JSON
}
```

---

### 3.3 剧本服务 (Script Service)

#### 职责
- 剧本创建与编辑
- 剧本解析(调用NLP服务)
- 角色管理
- 场景管理

#### API接口

```go
// 创建/更新剧本
POST /api/v1/projects/{project_id}/script
Request: {
    "content": "场景:现代都市街道,傍晚\n角色:小明(男,学生),小红(女,学生)\n\n小明(紧张): 那个...我有话想对你说\n...",
    "format": "text|markdown"
}
Response: {
    "script_id": "uuid",
    "version": 1,
    "word_count": 523,
    "estimated_duration": 87  // 秒
}

// 解析剧本
POST /api/v1/projects/{project_id}/script/parse
Response: {
    "parse_id": "uuid",
    "status": "processing",  // processing, completed, failed
    "task_id": "task_uuid"
}

// 获取解析结果
GET /api/v1/projects/{project_id}/script/parsed
Response: {
    "scenes": [
        {
            "id": 1,
            "location": "现代都市街道",
            "time": "傍晚",
            "characters": ["小明", "小红"],
            "shots": [
                {
                    "type": "dialogue",
                    "character": "小明",
                    "text": "那个...我有话想对你说",
                    "emotion": "紧张",
                    "duration": 3
                }
            ]
        }
    ],
    "characters": [
        {
            "name": "小明",
            "attributes": {
                "gender": "男",
                "role": "学生"
            }
        }
    ]
}

// 角色管理
POST /api/v1/projects/{project_id}/characters
Request: {
    "name": "小明",
    "description": "高中生,阳光开朗",
    "appearance": {
        "gender": "male",
        "age": "17",
        "hair": "黑色短发",
        "clothing": "校服",
        "features": ["眼镜", "书包"]
    },
    "reference_images": ["url1", "url2"]
}
Response: {
    "character_id": "uuid"
}

GET /api/v1/projects/{project_id}/characters
GET /api/v1/projects/{project_id}/characters/{character_id}
PATCH /api/v1/projects/{project_id}/characters/{character_id}
DELETE /api/v1/projects/{project_id}/characters/{character_id}
```

#### 数据模型

```go
type Script struct {
    ID          string    `gorm:"primaryKey;type:uuid"`
    ProjectID   string    `gorm:"uniqueIndex;not null"`
    Content     string    `gorm:"type:text;not null"`
    Format      string    `gorm:"default:'text'"` // text, markdown
    WordCount   int       `gorm:"default:0"`
    Version     int       `gorm:"default:1"`
    CreatedAt   time.Time
    UpdatedAt   time.Time
}

// MongoDB文档
type ParsedScript struct {
    ID          string                 `bson:"_id"`
    ProjectID   string                 `bson:"project_id"`
    Scenes      []Scene                `bson:"scenes"`
    Characters  []CharacterMention     `bson:"characters"`
    Metadata    map[string]interface{} `bson:"metadata"`
    ParsedAt    time.Time              `bson:"parsed_at"`
}

type Scene struct {
    ID         int      `bson:"id"`
    Location   string   `bson:"location"`
    Time       string   `bson:"time"`
    Characters []string `bson:"characters"`
    Shots      []Shot   `bson:"shots"`
}

type Shot struct {
    Type      string  `bson:"type"` // dialogue, narration, action
    Character string  `bson:"character,omitempty"`
    Text      string  `bson:"text"`
    Emotion   string  `bson:"emotion,omitempty"`
    Duration  float64 `bson:"duration"`
}

// PostgreSQL
type Character struct {
    ID              string    `gorm:"primaryKey;type:uuid"`
    ProjectID       string    `gorm:"index;not null"`
    Name            string    `gorm:"not null"`
    Description     string
    Appearance      JSONB     `gorm:"type:jsonb"` // 外貌描述JSON
    ReferenceImages JSONB     `gorm:"type:jsonb"` // 参考图片URL数组
    EmbeddingData   []byte    `gorm:"type:bytea"` // 向量数据
    VoiceID         string    // TTS音色ID
    CreatedAt       time.Time
    UpdatedAt       time.Time
}
```

---

### 3.4 生成服务 (Generator Service)

#### 职责
- 分镜脚本生成
- 图像生成任务调度
- 角色一致性控制
- 生成任务状态管理

#### API接口

```go
// 生成分镜脚本
POST /api/v1/projects/{project_id}/storyboard/generate
Request: {
    "parsed_script_id": "uuid",
    "options": {
        "max_shots": 50,
        "shot_duration_range": [2, 8]
    }
}
Response: {
    "task_id": "uuid",
    "status": "queued"
}

// 获取分镜脚本
GET /api/v1/projects/{project_id}/storyboard
Response: {
    "storyboard_id": "uuid",
    "shots": [
        {
            "shot_id": "uuid",
            "order": 1,
            "type": "closeup",  // closeup, medium, long, over-shoulder
            "scene_description": "小明紧张的表情特写",
            "characters": ["小明"],
            "duration": 3.0,
            "transition": "cut",  // cut, fade, dissolve, wipe
            "image_url": null,  // 未生成时为null
            "status": "pending"  // pending, generating, completed, failed
        }
    ]
}

// 生成所有镜头图像
POST /api/v1/projects/{project_id}/storyboard/generate-images
Response: {
    "batch_task_id": "uuid",
    "total_shots": 15,
    "status": "queued"
}

// 重新生成单个镜头
POST /api/v1/projects/{project_id}/shots/{shot_id}/regenerate
Request: {
    "prompt_override": "可选的自定义prompt"
}
Response: {
    "task_id": "uuid",
    "status": "queued"
}

// 获取生成任务状态
GET /api/v1/tasks/{task_id}
Response: {
    "task_id": "uuid",
    "type": "image_generation",
    "status": "processing",  // queued, processing, completed, failed
    "progress": 45,
    "result": {...},
    "error": null,
    "created_at": "...",
    "updated_at": "..."
}
```

#### 数据模型

```go
// MongoDB
type Storyboard struct {
    ID        string    `bson:"_id"`
    ProjectID string    `bson:"project_id"`
    Shots     []Shot    `bson:"shots"`
    CreatedAt time.Time `bson:"created_at"`
    UpdatedAt time.Time `bson:"updated_at"`
}

type StoryboardShot struct {
    ShotID           string                 `bson:"shot_id"`
    Order            int                    `bson:"order"`
    Type             string                 `bson:"type"`
    SceneDescription string                 `bson:"scene_description"`
    Characters       []string               `bson:"characters"`
    Duration         float64                `bson:"duration"`
    Transition       string                 `bson:"transition"`
    ImageURL         string                 `bson:"image_url"`
    PromptUsed       string                 `bson:"prompt_used"`
    GenerationParams map[string]interface{} `bson:"generation_params"`
    Status           string                 `bson:"status"`
    Dialogue         *Dialogue              `bson:"dialogue,omitempty"`
    SoundEffects     []string               `bson:"sound_effects"`
}

type Dialogue struct {
    CharacterID string `bson:"character_id"`
    Text        string `bson:"text"`
    AudioURL    string `bson:"audio_url"`
}

// PostgreSQL - 任务表
type Task struct {
    ID         string    `gorm:"primaryKey;type:uuid"`
    UserID     string    `gorm:"index;not null"`
    ProjectID  string    `gorm:"index"`
    Type       string    `gorm:"not null"` // image_generation, tts, video_render
    Status     string    `gorm:"default:'queued'"` // queued, processing, completed, failed
    Progress   int       `gorm:"default:0"`
    Priority   int       `gorm:"default:0"`
    Payload    JSONB     `gorm:"type:jsonb"` // 任务参数
    Result     JSONB     `gorm:"type:jsonb"` // 任务结果
    Error      string
    RetryCount int       `gorm:"default:0"`
    CreatedAt  time.Time
    UpdatedAt  time.Time
    StartedAt  *time.Time
    CompletedAt *time.Time
}
```

---

### 3.5 音频服务 (Audio Service)

#### 职责
- BGM管理与推荐
- 音效管理
- TTS语音合成
- 音频处理(剪辑、混音)

#### API接口

```go
// 获取BGM库
GET /api/v1/audio/bgm?category=happy&page=1&page_size=20
Response: {
    "bgm_list": [
        {
            "id": "uuid",
            "name": "欢快的一天",
            "category": "happy",
            "duration": 120,
            "url": "s3://...",
            "preview_url": "s3://..."
        }
    ]
}

// 智能推荐BGM
POST /api/v1/projects/{project_id}/audio/recommend-bgm
Request: {
    "script_emotion": "romantic",
    "duration": 60
}
Response: {
    "recommendations": [
        {
            "bgm_id": "uuid",
            "name": "浪漫时刻",
            "score": 0.95
        }
    ]
}

// 设置项目BGM
POST /api/v1/projects/{project_id}/audio/bgm
Request: {
    "bgm_id": "uuid",
    "volume": 0.7,
    "start_time": 0,
    "fade_in": 2,
    "fade_out": 3
}

// 获取音效库
GET /api/v1/audio/sound-effects?category=action

// 为镜头添加音效
POST /api/v1/projects/{project_id}/shots/{shot_id}/sound-effects
Request: {
    "effect_ids": ["uuid1", "uuid2"],
    "custom_effects": [
        {
            "file_url": "uploaded_url",
            "volume": 0.8
        }
    ]
}

// 生成TTS语音
POST /api/v1/audio/tts/generate
Request: {
    "text": "那个...我有话想对你说",
    "character_id": "uuid",
    "voice_id": "zh-CN-XiaoxiaoNeural",
    "emotion": "nervous",
    "speed": 1.0
}
Response: {
    "task_id": "uuid",
    "status": "queued"
}

// 批量生成对话语音
POST /api/v1/projects/{project_id}/audio/generate-dialogues
Response: {
    "batch_task_id": "uuid",
    "total_dialogues": 25
}
```

#### 数据模型

```go
type BGM struct {
    ID          string    `gorm:"primaryKey;type:uuid"`
    Name        string    `gorm:"not null"`
    Category    string    `gorm:"index"` // happy, sad, tense, romantic
    Duration    int       `gorm:"not null"` // 秒
    FileURL     string    `gorm:"not null"`
    PreviewURL  string
    LicenseType string    `gorm:"default:'royalty_free'"` // royalty_free, custom
    Tags        JSONB     `gorm:"type:jsonb"`
    CreatedAt   time.Time
}

type SoundEffect struct {
    ID        string    `gorm:"primaryKey;type:uuid"`
    Name      string    `gorm:"not null"`
    Category  string    `gorm:"index"` // environment, action, emotion, comic
    FileURL   string    `gorm:"not null"`
    Duration  float64   `gorm:"not null"`
    Tags      JSONB     `gorm:"type:jsonb"`
    CreatedAt time.Time
}

type ProjectAudio struct {
    ID          string    `gorm:"primaryKey;type:uuid"`
    ProjectID   string    `gorm:"uniqueIndex;not null"`
    BGMID       string    `gorm:"index"`
    BGMVolume   float64   `gorm:"default:0.5"`
    BGMStartTime float64  `gorm:"default:0"`
    FadeIn      float64   `gorm:"default:0"`
    FadeOut     float64   `gorm:"default:0"`
    Settings    JSONB     `gorm:"type:jsonb"` // 其他音频设置
    UpdatedAt   time.Time
}
```

---

### 3.6 渲染服务 (Render Service)

#### 职责
- 视频合成与渲染
- 字幕添加
- 特效处理
- 导出管理

#### API接口

```go
// 预览视频(低质量快速渲染)
POST /api/v1/projects/{project_id}/render/preview
Response: {
    "task_id": "uuid",
    "status": "queued"
}

// 最终渲染
POST /api/v1/projects/{project_id}/render/final
Request: {
    "resolution": "1080p",  // 720p, 1080p, 4k
    "format": "mp4",  // mp4, mov
    "platform_preset": "douyin",  // douyin, bilibili, kuaishou, custom
    "subtitle_style": "simple",
    "watermark": {
        "enabled": true,
        "position": "bottom-right",
        "opacity": 0.7
    }
}
Response: {
    "render_task_id": "uuid",
    "estimated_time": 180  // 秒
}

// 获取渲染进度
GET /api/v1/tasks/{render_task_id}
Response: {
    "task_id": "uuid",
    "status": "processing",
    "progress": 65,
    "current_step": "rendering_video",  // merging_assets, adding_audio, rendering_video, adding_subtitles
    "estimated_remaining": 90
}

// 下载视频
GET /api/v1/projects/{project_id}/video/download
Response: {
    "download_url": "https://...",
    "expires_at": "2025-10-27T10:00:00Z",
    "file_size": 15728640,  // bytes
    "duration": 62  // 秒
}

// 字幕管理
GET /api/v1/projects/{project_id}/subtitles
POST /api/v1/projects/{project_id}/subtitles
PATCH /api/v1/projects/{project_id}/subtitles/{subtitle_id}
```

#### 数据模型

```go
type Video struct {
    ID            string    `gorm:"primaryKey;type:uuid"`
    ProjectID     string    `gorm:"index;not null"`
    StoryboardID  string    `gorm:"not null"`
    Type          string    `gorm:"not null"` // preview, final
    OutputURL     string
    Resolution    string    `gorm:"not null"` // 720p, 1080p, 4k
    Format        string    `gorm:"not null"` // mp4, mov
    FileSize      int64     // bytes
    Duration      float64   // 秒
    RenderStatus  string    `gorm:"default:'pending'"` // pending, rendering, completed, failed
    RenderProgress int      `gorm:"default:0"`
    Settings      JSONB     `gorm:"type:jsonb"` // 渲染设置
    CreatedAt     time.Time
    CompletedAt   *time.Time
}

type Subtitle struct {
    ID         string    `gorm:"primaryKey;type:uuid"`
    ProjectID  string    `gorm:"index;not null"`
    ShotID     string    `gorm:"index"`
    Text       string    `gorm:"not null"`
    StartTime  float64   `gorm:"not null"` // 秒
    EndTime    float64   `gorm:"not null"`
    Style      JSONB     `gorm:"type:jsonb"` // 字幕样式
    Position   string    `gorm:"default:'bottom-center'"`
    CreatedAt  time.Time
    UpdatedAt  time.Time
}
```

---

### 3.7 素材服务 (Asset Service)

#### 职责
- 文件上传管理
- 对象存储操作
- CDN加速
- 资源清理

#### API接口

```go
// 获取上传凭证
GET /api/v1/assets/upload-token?file_type=image&project_id=uuid
Response: {
    "upload_url": "https://...",
    "upload_token": "...",
    "expires_at": "..."
}

// 上传完成回调
POST /api/v1/assets/upload-complete
Request: {
    "file_key": "projects/uuid/images/xxx.png",
    "file_size": 1024000,
    "content_type": "image/png"
}
Response: {
    "asset_id": "uuid",
    "url": "https://cdn.../xxx.png"
}

// 获取资源列表
GET /api/v1/projects/{project_id}/assets?type=image
Response: {
    "assets": [
        {
            "id": "uuid",
            "type": "image",
            "url": "https://...",
            "size": 1024000,
            "created_at": "..."
        }
    ]
}

// 删除资源
DELETE /api/v1/assets/{asset_id}
```

#### 数据模型

```go
type Asset struct {
    ID          string    `gorm:"primaryKey;type:uuid"`
    ProjectID   string    `gorm:"index"`
    UserID      string    `gorm:"index;not null"`
    Type        string    `gorm:"index;not null"` // image, audio, video
    FileName    string    `gorm:"not null"`
    FileKey     string    `gorm:"uniqueIndex;not null"` // S3 key
    FileSize    int64     `gorm:"not null"`
    ContentType string    `gorm:"not null"`
    URL         string    `gorm:"not null"`
    Status      string    `gorm:"default:'active'"` // active, deleted
    Metadata    JSONB     `gorm:"type:jsonb"`
    CreatedAt   time.Time
    DeletedAt   *time.Time
}
```

---

## 4. 核心工作流程

### 4.1 完整创作流程

```
1. 用户认证
   User -> API Gateway -> User Service
   └─> 返回JWT Token

2. 创建项目
   User -> API Gateway -> Project Service -> PostgreSQL
   └─> 返回Project ID

3. 编写剧本
   User -> API Gateway -> Script Service -> PostgreSQL
   └─> 保存剧本内容

4. 解析剧本
   User -> API Gateway -> Script Service
   └─> Script Service -> MQ -> NLP Worker (Python AI)
       └─> 解析结果 -> MongoDB
       └─> 更新任务状态 -> Redis
   └─> 返回ParsedScript

5. 生成分镜
   User -> API Gateway -> Generator Service
   └─> 调用LLM生成分镜脚本
   └─> 保存Storyboard -> MongoDB

6. 生成图像 (异步批量)
   User -> API Gateway -> Generator Service
   └─> 创建批量任务 -> MQ
   └─> Image Gen Worker (Python) 并行处理
       ├─> 检查角色一致性
       ├─> 生成图像
       ├─> 上传到S3 -> Asset Service
       └─> 更新Shot状态 -> MongoDB
   └─> WebSocket推送进度 -> User

7. 添加音频
   User -> API Gateway -> Audio Service
   ├─> 选择BGM -> PostgreSQL
   └─> 生成TTS (可选) -> MQ -> TTS Worker
       └─> 保存音频文件 -> S3

8. 渲染视频
   User -> API Gateway -> Render Service
   └─> 创建渲染任务 -> MQ -> Render Worker
       ├─> 下载所有素材 (图像、音频)
       ├─> FFmpeg合成视频
       ├─> 添加字幕和特效
       ├─> 上传最终视频 -> S3
       └─> 更新Video状态 -> PostgreSQL
   └─> WebSocket推送进度 -> User

9. 下载视频
   User -> API Gateway -> Render Service
   └─> 生成临时下载链接 (S3 Presigned URL)
```

### 4.2 任务队列处理流程

```
生产者 (Go Service)
    │
    ├─> 创建任务记录 (PostgreSQL)
    ├─> 发送消息到MQ (RabbitMQ)
    └─> 返回Task ID给用户
         │
         ▼
消息队列 (RabbitMQ)
    │
    ├─> image_generation_queue (优先级队列)
    ├─> tts_queue
    ├─> video_render_queue
    └─> nlp_processing_queue
         │
         ▼
消费者 Worker (Python/Go)
    │
    ├─> 接收任务消息
    ├─> 更新任务状态: processing (Redis + PostgreSQL)
    ├─> 执行AI处理
    ├─> 保存结果 (S3 + MongoDB/PostgreSQL)
    ├─> 更新任务状态: completed (Redis + PostgreSQL)
    └─> 发送WebSocket通知 (可选)
         │
         ▼
用户查询结果
    ├─> 轮询 GET /api/v1/tasks/{task_id}
    └─> WebSocket实时推送
```

---

## 5. 数据库设计

### 5.1 PostgreSQL表结构

```sql
-- 用户表
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(100) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 订阅表
CREATE TABLE subscriptions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    plan VARCHAR(50) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    videos_quota INT DEFAULT 5,
    videos_used INT DEFAULT 0,
    expires_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);

-- 项目表
CREATE TABLE projects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    name VARCHAR(255) NOT NULL,
    description TEXT,
    style VARCHAR(50) NOT NULL,
    aspect_ratio VARCHAR(10) NOT NULL,
    target_duration INT DEFAULT 60,
    status VARCHAR(50) DEFAULT 'draft',
    progress INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_projects_user_id ON projects(user_id);
CREATE INDEX idx_projects_status ON projects(status);

-- 剧本表
CREATE TABLE scripts (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID UNIQUE NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    content TEXT NOT NULL,
    format VARCHAR(20) DEFAULT 'text',
    word_count INT DEFAULT 0,
    version INT DEFAULT 1,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 角色表
CREATE TABLE characters (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    appearance JSONB,
    reference_images JSONB,
    embedding_data BYTEA,
    voice_id VARCHAR(100),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_characters_project_id ON characters(project_id);

-- 任务表
CREATE TABLE tasks (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id UUID NOT NULL REFERENCES users(id),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    type VARCHAR(50) NOT NULL,
    status VARCHAR(50) DEFAULT 'queued',
    progress INT DEFAULT 0,
    priority INT DEFAULT 0,
    payload JSONB,
    result JSONB,
    error TEXT,
    retry_count INT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    started_at TIMESTAMP,
    completed_at TIMESTAMP
);
CREATE INDEX idx_tasks_user_id ON tasks(user_id);
CREATE INDEX idx_tasks_project_id ON tasks(project_id);
CREATE INDEX idx_tasks_status ON tasks(status);
CREATE INDEX idx_tasks_type ON tasks(type);

-- 视频表
CREATE TABLE videos (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID NOT NULL REFERENCES projects(id) ON DELETE CASCADE,
    storyboard_id VARCHAR(100),
    type VARCHAR(20) NOT NULL,
    output_url TEXT,
    resolution VARCHAR(20) NOT NULL,
    format VARCHAR(10) NOT NULL,
    file_size BIGINT,
    duration DECIMAL(10,2),
    render_status VARCHAR(50) DEFAULT 'pending',
    render_progress INT DEFAULT 0,
    settings JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);
CREATE INDEX idx_videos_project_id ON videos(project_id);

-- BGM表
CREATE TABLE bgm (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50),
    duration INT NOT NULL,
    file_url TEXT NOT NULL,
    preview_url TEXT,
    license_type VARCHAR(50) DEFAULT 'royalty_free',
    tags JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_bgm_category ON bgm(category);

-- 音效表
CREATE TABLE sound_effects (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255) NOT NULL,
    category VARCHAR(50),
    file_url TEXT NOT NULL,
    duration DECIMAL(10,2) NOT NULL,
    tags JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_sound_effects_category ON sound_effects(category);

-- 素材表
CREATE TABLE assets (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    project_id UUID REFERENCES projects(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id),
    type VARCHAR(50) NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_key TEXT UNIQUE NOT NULL,
    file_size BIGINT NOT NULL,
    content_type VARCHAR(100) NOT NULL,
    url TEXT NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    metadata JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);
CREATE INDEX idx_assets_project_id ON assets(project_id);
CREATE INDEX idx_assets_user_id ON assets(user_id);
CREATE INDEX idx_assets_type ON assets(type);
```

### 5.2 MongoDB集合设计

```javascript
// parsed_scripts 集合
{
    _id: ObjectId,
    project_id: "uuid",
    scenes: [
        {
            id: 1,
            location: "现代都市街道",
            time: "傍晚",
            characters: ["小明", "小红"],
            shots: [
                {
                    type: "dialogue",
                    character: "小明",
                    text: "那个...我有话想对你说",
                    emotion: "紧张",
                    duration: 3.0
                }
            ]
        }
    ],
    characters: [
        {
            name: "小明",
            attributes: {
                gender: "男",
                role: "学生"
            }
        }
    ],
    metadata: {
        total_scenes: 5,
        total_shots: 15,
        estimated_duration: 87
    },
    parsed_at: ISODate("2025-10-26T10:00:00Z")
}

// storyboards 集合
{
    _id: ObjectId,
    project_id: "uuid",
    shots: [
        {
            shot_id: "uuid",
            order: 1,
            type: "closeup",
            scene_description: "小明紧张的表情特写",
            characters: ["小明"],
            duration: 3.0,
            transition: "cut",
            image_url: "https://cdn.../shot_001.png",
            prompt_used: "anime style, close-up, nervous young man...",
            generation_params: {
                model: "sdxl",
                steps: 30,
                cfg_scale: 7.5
            },
            status: "completed",
            dialogue: {
                character_id: "uuid",
                text: "那个...我有话想对你说",
                audio_url: "https://cdn.../audio_001.mp3"
            },
            sound_effects: [
                "https://cdn.../heartbeat.mp3"
            ]
        }
    ],
    created_at: ISODate("2025-10-26T11:00:00Z"),
    updated_at: ISODate("2025-10-26T12:00:00Z")
}
```

### 5.3 Redis数据结构

```
# 用户会话
session:{user_id} -> JSON (TTL: 7天)

# 任务状态缓存
task:{task_id} -> JSON (TTL: 24小时)
{
    "status": "processing",
    "progress": 45,
    "updated_at": "2025-10-26T12:00:00Z"
}

# 用户配额缓存
quota:{user_id} -> JSON (TTL: 1小时)
{
    "videos_quota": 30,
    "videos_used": 12,
    "plan": "basic"
}

# 任务队列 (使用Asynq)
asynq:queues:image_generation -> List
asynq:queues:tts -> List
asynq:queues:video_render -> List

# 限流计数器
rate_limit:api:{user_id}:{endpoint} -> Counter (TTL: 1分钟)

# 项目锁
lock:project:{project_id} -> String (TTL: 30秒)
```

---

## 6. API接口规范

### 6.1 接口设计原则

- **RESTful风格**: 使用标准HTTP方法(GET, POST, PATCH, DELETE)
- **版本控制**: 通过URL路径(/api/v1/)进行版本管理
- **统一响应格式**: 所有接口返回统一的JSON结构
- **错误处理**: 标准的HTTP状态码+详细错误信息
- **分页**: 使用page和page_size参数
- **过滤排序**: 支持查询参数过滤和排序

### 6.2 统一响应格式

#### 成功响应

```json
{
    "code": 0,
    "message": "success",
    "data": {
        // 实际数据
    },
    "timestamp": "2025-10-26T12:00:00Z",
    "request_id": "uuid"
}
```

#### 错误响应

```json
{
    "code": 40001,
    "message": "Invalid request parameters",
    "error": {
        "field": "email",
        "reason": "email format is invalid"
    },
    "timestamp": "2025-10-26T12:00:00Z",
    "request_id": "uuid"
}
```

### 6.3 HTTP状态码

| 状态码 | 说明 | 使用场景 |
|-------|------|----------|
| 200 | OK | 成功 |
| 201 | Created | 资源创建成功 |
| 204 | No Content | 删除成功 |
| 400 | Bad Request | 请求参数错误 |
| 401 | Unauthorized | 未认证 |
| 403 | Forbidden | 无权限 |
| 404 | Not Found | 资源不存在 |
| 409 | Conflict | 资源冲突 |
| 429 | Too Many Requests | 请求过于频繁 |
| 500 | Internal Server Error | 服务器错误 |
| 503 | Service Unavailable | 服务不可用 |

### 6.4 错误码设计

```
10xxx - 通用错误
  10001: 系统错误
  10002: 参数错误
  10003: 资源不存在

20xxx - 认证授权错误
  20001: 未登录
  20002: Token过期
  20003: 无权限
  20004: 账号被禁用

30xxx - 业务错误
  30001: 配额不足
  30002: 项目不存在
  30003: 生成任务失败
  30004: 视频渲染失败

40xxx - 第三方服务错误
  40001: AI服务调用失败
  40002: 存储服务错误
  40003: 支付服务错误
```

### 6.5 认证机制

#### JWT Token结构

```json
{
    "user_id": "uuid",
    "username": "user123",
    "email": "user@example.com",
    "plan": "basic",
    "exp": 1730000000,
    "iat": 1729900000
}
```

#### 请求头

```
Authorization: Bearer {access_token}
X-Request-ID: {uuid}
```

---

## 7. 部署架构

### 7.1 开发环境

```
Docker Compose本地部署

services:
  - api-gateway (Traefik)
  - user-service (Go)
  - project-service (Go)
  - script-service (Go)
  - generator-service (Go)
  - audio-service (Go)
  - render-service (Go)
  - asset-service (Go)
  - nlp-worker (Python)
  - image-gen-worker (Python)
  - tts-worker (Python)
  - render-worker (Go/Python)
  - postgres
  - mongodb
  - redis
  - rabbitmq
  - minio
```

### 7.2 生产环境 (Kubernetes)

```yaml
# 服务部署清单

API网关:
  - Deployment: traefik (2 replicas)
  - Service: LoadBalancer

Go微服务:
  - Deployment: user-service (3 replicas)
  - Deployment: project-service (3 replicas)
  - Deployment: script-service (2 replicas)
  - Deployment: generator-service (3 replicas)
  - Deployment: audio-service (2 replicas)
  - Deployment: render-service (2 replicas)
  - Deployment: asset-service (3 replicas)

AI Workers:
  - Deployment: nlp-worker (2 replicas, GPU)
  - Deployment: image-gen-worker (4 replicas, GPU)
  - Deployment: tts-worker (2 replicas, GPU)
  - Deployment: render-worker (3 replicas)

数据层:
  - StatefulSet: postgres (1 master + 2 replicas)
  - StatefulSet: mongodb (3 replicas)
  - StatefulSet: redis (3 nodes cluster)
  - StatefulSet: rabbitmq (3 nodes cluster)

存储:
  - External: S3 / MinIO Cluster
  - PVC: 持久化存储卷

监控:
  - Deployment: prometheus
  - Deployment: grafana
  - Deployment: jaeger
```

### 7.3 扩展策略

#### 水平扩展

```
无状态服务 (Go微服务):
  - HPA: 基于CPU/内存自动扩展
  - 目标: CPU 70%, Memory 80%
  - Min: 2, Max: 10

有状态服务 (数据库):
  - 主从复制 + 读写分离
  - 分库分表 (项目数据按user_id分片)

GPU Worker:
  - 独立GPU节点池
  - 根据任务队列长度动态扩展
  - 使用Spot实例降低成本
```

#### 缓存策略

```
L1 - 应用内存缓存 (Go map + sync.Map)
  - 热点配置数据
  - TTL: 5分钟

L2 - Redis缓存
  - 用户会话
  - 任务状态
  - 用户配额
  - TTL: 根据数据类型

L3 - CDN缓存
  - 静态资源(图片、视频)
  - 音乐、音效文件
  - TTL: 7天
```

---

## 8. 性能优化

### 8.1 API性能优化

```go
// 1. 连接池配置
db.SetMaxOpenConns(100)
db.SetMaxIdleConns(20)
db.SetConnMaxLifetime(time.Hour)

// 2. 查询优化
// 使用索引
// 避免N+1查询
// 使用批量查询

// 3. 缓存策略
// 缓存热点数据
// 缓存穿透防护(布隆过滤器)
// 缓存雪崩防护(过期时间加随机值)

// 4. 并发控制
// 使用goroutine池
// 限制并发数
```

### 8.2 AI生成优化

```
1. 批量生成
   - 多个镜头并行生成
   - GPU资源池管理

2. 模型优化
   - 使用量化模型(FP16/INT8)
   - TensorRT加速

3. 缓存复用
   - 相似场景背景复用
   - 角色立绘缓存

4. 分级生成
   - 预览: 低质量快速生成(15步)
   - 最终: 高质量生成(30步)
```

### 8.3 数据库优化

```sql
-- 1. 索引优化
CREATE INDEX CONCURRENTLY idx_projects_user_status
ON projects(user_id, status);

-- 2. 分区表
CREATE TABLE tasks_2025_10 PARTITION OF tasks
FOR VALUES FROM ('2025-10-01') TO ('2025-11-01');

-- 3. 读写分离
-- 读操作 -> 从库
-- 写操作 -> 主库

-- 4. 慢查询优化
-- 使用EXPLAIN分析
-- 添加合适索引
-- 优化复杂查询
```

---

## 9. 安全设计

### 9.1 认证与授权

```
认证方式:
  - JWT Token认证
  - Token刷新机制
  - OAuth 2.0(社交登录)

授权控制:
  - RBAC(基于角色的访问控制)
  - 资源所有权验证
  - 接口权限控制
```

### 9.2 数据安全

```
1. 传输安全
   - HTTPS/TLS加密
   - API签名验证

2. 存储安全
   - 密码bcrypt加密
   - 敏感数据AES加密
   - 数据库备份加密

3. 访问控制
   - IP白名单
   - 限流防护
   - DDoS防护
```

### 9.3 安全防护

```go
// 1. SQL注入防护
// 使用参数化查询
db.Where("email = ?", email).First(&user)

// 2. XSS防护
// 输入验证和输出编码
html.EscapeString(userInput)

// 3. CSRF防护
// CSRF Token验证

// 4. 限流
// 令牌桶算法
limiter := rate.NewLimiter(10, 20) // 10 req/s, burst 20

// 5. 熔断
// Circuit Breaker模式
```

---

## 10. 监控与告警

### 10.1 监控指标

#### 服务监控

```
- QPS (每秒请求数)
- 响应时间 (P50, P95, P99)
- 错误率
- 并发连接数
- 服务可用性
```

#### 资源监控

```
- CPU使用率
- 内存使用率
- 磁盘IO
- 网络IO
- GPU使用率
```

#### 业务监控

```
- 用户注册数
- 项目创建数
- 视频生成成功率
- 任务队列长度
- 付费转化率
```

### 10.2 日志管理

```go
// 结构化日志
logger.Info("project created",
    zap.String("project_id", projectID),
    zap.String("user_id", userID),
    zap.String("style", style),
)

// 日志级别
// DEBUG -> INFO -> WARN -> ERROR -> FATAL

// 日志收集
// ELK Stack (Elasticsearch + Logstash + Kibana)
// 或 Loki + Grafana
```

### 10.3 告警策略

```yaml
告警规则:
  - 服务可用性 < 99.9%
  - 错误率 > 1%
  - P95响应时间 > 1s
  - CPU使用率 > 80%
  - 内存使用率 > 85%
  - 任务队列堆积 > 1000
  - GPU使用率 > 95%

告警渠道:
  - 邮件
  - 企业微信/钉钉
  - PagerDuty
  - Slack
```

---

## 11. 项目结构

### 11.1 代码组织

```
1504/
├── cmd/                          # 服务入口
│   ├── api-gateway/
│   │   └── main.go
│   ├── user-service/
│   │   └── main.go
│   ├── project-service/
│   │   └── main.go
│   ├── script-service/
│   │   └── main.go
│   ├── generator-service/
│   │   └── main.go
│   ├── audio-service/
│   │   └── main.go
│   ├── render-service/
│   │   └── main.go
│   └── asset-service/
│       └── main.go
│
├── internal/                     # 私有代码
│   ├── user/
│   │   ├── handler/             # HTTP handlers
│   │   ├── service/             # 业务逻辑
│   │   ├── repository/          # 数据访问
│   │   └── model/               # 数据模型
│   ├── project/
│   ├── script/
│   ├── generator/
│   ├── audio/
│   ├── render/
│   └── asset/
│
├── pkg/                          # 公共库
│   ├── auth/                    # 认证
│   ├── config/                  # 配置
│   ├── database/                # 数据库
│   ├── cache/                   # 缓存
│   ├── mq/                      # 消息队列
│   ├── storage/                 # 对象存储
│   ├── logger/                  # 日志
│   ├── middleware/              # 中间件
│   ├── errors/                  # 错误处理
│   ├── utils/                   # 工具函数
│   └── validator/               # 参数验证
│
├── api/                          # API定义
│   ├── proto/                   # gRPC proto
│   └── openapi/                 # OpenAPI/Swagger
│
├── migrations/                   # 数据库迁移
│   ├── postgres/
│   └── mongodb/
│
├── deployments/                  # 部署配置
│   ├── docker/
│   │   └── docker-compose.yml
│   └── k8s/
│       ├── user-service.yaml
│       ├── project-service.yaml
│       └── ...
│
├── scripts/                      # 脚本
│   ├── build.sh
│   ├── deploy.sh
│   └── migrate.sh
│
├── configs/                      # 配置文件
│   ├── dev.yaml
│   ├── prod.yaml
│   └── test.yaml
│
├── docs/                         # 文档
│   ├── api.md
│   ├── architecture.md
│   └── deployment.md
│
├── tests/                        # 测试
│   ├── integration/
│   └── e2e/
│
├── ai-services/                  # Python AI服务
│   ├── nlp-worker/
│   ├── image-gen-worker/
│   ├── tts-worker/
│   └── render-worker/
│
├── go.mod
├── go.sum
├── Makefile
└── README.md
```

### 11.2 分层架构

```
┌─────────────────────────────────────────┐
│           Handler Layer                 │  (HTTP/gRPC处理)
│  - 参数验证                             │
│  - 请求解析                             │
│  - 响应封装                             │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│          Service Layer                  │  (业务逻辑)
│  - 业务规则                             │
│  - 事务控制                             │
│  - 调用Repository                       │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│        Repository Layer                 │  (数据访问)
│  - 数据库操作                           │
│  - 缓存操作                             │
│  - 第三方API调用                        │
└──────────────┬──────────────────────────┘
               │
┌──────────────▼──────────────────────────┐
│          Data Layer                     │  (数据存储)
│  - PostgreSQL                           │
│  - MongoDB                              │
│  - Redis                                │
└─────────────────────────────────────────┘
```

### 11.3 依赖注入示例

```go
// internal/user/handler/handler.go
type UserHandler struct {
    userService service.UserService
    logger      *zap.Logger
}

func NewUserHandler(userService service.UserService, logger *zap.Logger) *UserHandler {
    return &UserHandler{
        userService: userService,
        logger:      logger,
    }
}

// internal/user/service/service.go
type UserService interface {
    Register(ctx context.Context, req *RegisterRequest) (*User, error)
    Login(ctx context.Context, req *LoginRequest) (*AuthResponse, error)
}

type userService struct {
    userRepo   repository.UserRepository
    authClient auth.Client
    cache      cache.Cache
}

func NewUserService(
    userRepo repository.UserRepository,
    authClient auth.Client,
    cache cache.Cache,
) UserService {
    return &userService{
        userRepo:   userRepo,
        authClient: authClient,
        cache:      cache,
    }
}

// cmd/user-service/main.go
func main() {
    // 初始化依赖
    db := database.NewPostgres(config.DB)
    cache := cache.NewRedis(config.Redis)
    authClient := auth.NewJWTClient(config.JWT)

    // 创建Repository
    userRepo := repository.NewUserRepository(db)

    // 创建Service
    userService := service.NewUserService(userRepo, authClient, cache)

    // 创建Handler
    userHandler := handler.NewUserHandler(userService, logger)

    // 注册路由
    router := gin.New()
    userHandler.RegisterRoutes(router)

    // 启动服务
    router.Run(":8080")
}
```

---

## 12. 开发流程

### 12.1 开发规范

```
代码规范:
  - Go: 遵循Go官方代码规范
  - 使用golangci-lint检查
  - 代码审查必须通过

Git规范:
  - 分支: main, develop, feature/*, fix/*
  - Commit: 遵循Conventional Commits
    - feat: 新功能
    - fix: 修复bug
    - docs: 文档
    - refactor: 重构
    - test: 测试

API文档:
  - 使用Swagger生成API文档
  - 及时更新文档
```

### 12.2 测试策略

```go
// 1. 单元测试
func TestUserService_Register(t *testing.T) {
    // 使用mock
    mockRepo := repository.NewMockUserRepository()
    service := service.NewUserService(mockRepo, nil, nil)

    // 测试
    user, err := service.Register(ctx, &req)
    assert.NoError(t, err)
    assert.NotNil(t, user)
}

// 2. 集成测试
// 测试API端到端流程

// 3. 性能测试
// 使用vegeta/wrk进行压测
```

### 12.3 CI/CD流程

```yaml
# .github/workflows/deploy.yml

name: CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Run tests
        run: |
          go test -v ./...

  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2

  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Build Docker images
        run: |
          docker build -t user-service ./cmd/user-service

  deploy:
    needs: [test, lint, build]
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    steps:
      - name: Deploy to K8s
        run: |
          kubectl apply -f deployments/k8s/
```

---

## 13. 成本估算

### 13.1 基础设施成本(月度)

```
计算资源:
  - K8s节点 (8C16G x 5): ¥3,000
  - GPU节点 (T4 x 4): ¥20,000
  - 负载均衡器: ¥500

存储:
  - 数据库存储 (1TB): ¥800
  - 对象存储 (10TB): ¥2,000
  - CDN流量 (20TB): ¥4,000

其他:
  - 域名+SSL证书: ¥200
  - 监控服务: ¥300
  - 消息队列: ¥600

小计: ¥31,400/月

按1000活跃用户计算:
  - 单用户成本: ¥31.4/月
  - 需客单价 > ¥50/月保证盈利
```

### 13.2 优化方案

```
1. GPU成本优化
   - 使用Spot实例(节省60%)
   - 使用Serverless GPU(按需付费)
   - 多云GPU资源池

2. 存储成本优化
   - 对象存储生命周期管理
   - 冷数据归档(S3 Glacier)
   - 压缩和去重

3. 带宽成本优化
   - CDN智能调度
   - 视频分级编码
   - 缓存策略优化
```

---

## 14. 技术债务与未来优化

### 14.1 技术债务

```
1. 微服务拆分粒度
   - 当前: 按功能模块拆分
   - 未来: 考虑按业务域拆分

2. 服务间通信
   - 当前: HTTP + gRPC混合
   - 未来: 统一使用gRPC

3. 数据一致性
   - 当前: 最终一致性
   - 未来: Saga模式处理分布式事务

4. 配置管理
   - 当前: 配置文件
   - 未来: 配置中心(Apollo/Nacos)
```

### 14.2 未来优化方向

```
1. AI模型优化
   - 自训练专用模型
   - 模型蒸馏降低推理成本
   - 边缘计算

2. 实时协作
   - WebRTC实时预览
   - 多人协同编辑

3. 智能化
   - AI自动优化分镜
   - 智能推荐系统
   - 用户行为分析

4. 国际化
   - 多语言支持
   - 多区域部署
   - 本地化运营
```

---

## 15. 附录

### 15.1 技术选型对比

| 技术 | 选型 | 备选方案 | 选择理由 |
|------|------|----------|----------|
| Web框架 | Gin | Fiber, Echo | 成熟稳定,生态好 |
| ORM | GORM | sqlx, ent | 功能全面,易用 |
| 消息队列 | RabbitMQ | Kafka, NATS | 轻量级,适合中小规模 |
| 服务发现 | Consul | etcd, Nacos | 简单易用 |
| 配置管理 | Viper | - | Go标准选择 |
| 日志 | Zap | Logrus | 高性能 |

### 15.2 参考资料

- [Go项目布局标准](https://github.com/golang-standards/project-layout)
- [Gin框架文档](https://gin-gonic.com/)
- [GORM文档](https://gorm.io/)
- [Kubernetes最佳实践](https://kubernetes.io/docs/concepts/)
- [微服务设计模式](https://microservices.io/patterns/)

---

**文档版本**: v1.0
**创建日期**: 2025-10-26
**维护者**: 开发团队
**下次更新**: 根据开发进度更新
